<?xml version="1.0" encoding="utf-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <!-- Product name as you want it to appear in Add/Remove Programs-->
  <!--<?define Platform = x64 ?>-->
  <?define Platform = $(env.BUILD_ARCH) ?>
  <?if $(var.Platform) = x64 ?>
  <?define ProductName = "DbPass (64 bit)" ?>
  <?define Win64 = "yes" ?>
  <?define PlatformProgramFilesFolder = "ProgramFiles64Folder" ?>
  <?define PlatformSystemFolder = "System64Folder" ?>
  <?else ?>
  <?define ProductName = "DbPass" ?>
  <?define Win64 = "no" ?>
  <?define PlatformProgramFilesFolder = "ProgramFilesFolder" ?>
  <?define PlatformSystemFolder = "SystemFolder" ?>
  <?endif ?>
  <?ifdef env.BUILD_NUMBER?>
  <?define ProductVersion="0.3.$(env.BUILD_NUMBER)"?>
  <?else?>
  <?define ProductVersion="0.3.1"?>
  <?endif?>
  <?define UpgradeCode="AAAA2F25-E626-4CC5-BC37-86477A2609AC"?>
  <?define BuildType = "RelWithDebInfo" ?>
  <Product Id="*" 
	   Name="$(var.ProductName)" Language="1033" 
	   Version="$(var.ProductVersion)"
	   Manufacturer="Ivan Brezina" 
	   UpgradeCode="$(var.UpgradeCode)">
    <Package Description="$(var.ProductName)"
	     Comments="Password tool for Oracle" 
	     InstallScope="perUser"
	     InstallPrivileges="limited"
	     Platform="$(var.Platform)"
	     InstallerVersion="200" Compressed="yes" />
    <Media Id="1" Cabinet="dbpass.cab" EmbedCab="yes" />
    <Icon Id="dbpass.ico" SourceFile="src\win32\data-storage4.ico" />
    <Property Id="ARPPRODUCTICON" Value="dbpass.ico" />
    <Property Id="ARPHELPLINK" Value="https://github.com/ibre5041/dbpass" />
    <Property Id="ARPURLINFOABOUT" Value="https://github.com/ibre5041/dbpass" />
    <Property Id="ARPNOREPAIR" Value="1" />

    <!--
    <Property Id="INSTALLLOCATION">
      <RegistrySearch Id="RegistrySearch" Type="raw" Root="HKLM" Win64="$(var.Win64)"
		      Key="Software\DbPass\DbPass" Name="InstallLocation" />
    </Property>
    !-->
    <!--<WixVariable Id="WixUIBannerBmp" Value="largelogo.bmp" />-->
    <WixVariable Id="WixUILicenseRtf" Value="LICENSE.rtf" />

    <Property Id="PREVIOUSVERSIONSINSTALLED" Secure="yes" />
    <Upgrade Id="$(var.UpgradeCode)">
      <UpgradeVersion 
	  OnlyDetect="no" 
	  Minimum="0.0.0.0" IncludeMinimum="yes"
	  Maximum="$(var.ProductVersion)" IncludeMaximum="no" 
	  Property="PREVIOUSFOUND" />
    </Upgrade>
    <!--
	<Condition Message="A newer version of this software is already installed.">
	NOT NEWERVERSIONDETECTED
	</Condition>
    -->

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="LocalAppDataFolder" Name="AppData">
	<Directory Id="AppRootDirectory" Name="DbPass"/>
      </Directory>
    </Directory>
    
    <DirectoryRef Id="AppRootDirectory">
      <Component Id="Registration.xml" Guid="f671ee4d-dd0a-4f7f-a4d1-1d181d2f3002" DiskId="1">
	<CreateFolder/>
	<RemoveFolder Id="RemoveAppRootDirectory" On="uninstall" />
	<!--<File Id="Registration.xml"    Name="Registration.xml" Source="Registration.xml" Checksum="no" />-->
	<File Id="dbpass.exe"          Name="dbpass.exe"       Source="src\$(var.BuildType)\dbpass.exe" />
	<File Id="dbpassgui.exe"       Name="dbpassgui.exe"    Source="src\$(var.BuildType)\dbpassgui.exe" />
	<RegistryKey Root="HKCU" Key="Software\DbPass\DbPass"  Action="createAndRemoveOnUninstall">
	  <RegistryValue Name="Version" Value="[ProductVersion]" Type="string" KeyPath="yes"/>
	</RegistryKey>
      </Component>


      <Directory Id="ProgramMenuFolder">
        <Directory Id="ProgramMenuSubfolder" Name="ODbPass">
          <Component Id="ApplicationShortcuts"
		     Guid="6e6001f0-d92a-43da-95bd-f21e48b5b37a">
            <Shortcut Id="ApplicationShortcut1" Name="DbPass"
		      Description="Password tool for Oracle"
		      Target="[AppRootDirectory]dbpassgui.exe"
		      WorkingDirectory="AppRootDirectory" />
	    <Shortcut Id="UninstallProduct"             
		      Name="Uninstall DbPass"
		      Description="Uninstalls DbPass"
		      Target="[$(var.PlatformSystemFolder)]msiexec.exe"
		      Arguments="/x [ProductCode]"/>
            <RegistryValue Root="HKCU" Key="Software\DbPass\DbPass"
			   Name="installed" Type="integer" Value="1" KeyPath="yes" />
            <RemoveFolder Id="ProgramMenuSubfolder" On="uninstall" />
          </Component>
        </Directory>
      </Directory>

      <Directory Id="DesktopFolder" Name="Desktop">
	<Component Id="DesktopShortcut" Guid="EC9BAF82-9766-481B-8E03-62754F190BBB">
	  <Condition>INSTALLDESKTOPSHORTCUT</Condition>
	  <CreateFolder/>
	  <RegistryKey Root="HKCU" Key="Software\DbPass\DbPass">
	    <RegistryValue Name="DTSC" Value="1" Type="integer" KeyPath="yes" />
	  </RegistryKey>
	  <Shortcut Id="DesktopShortcut" Directory="DesktopFolder" Name="DbPass" Target="[AppRootDirectory]dbpassgui.exe" WorkingDirectory="AppRootDirectory" />
	</Component>
	</Directory>

    </DirectoryRef>

    <InstallExecuteSequence>
      <!--<RemoveExistingProducts After="InstallValidate" />-->
      <RemoveExistingProducts Before="InstallInitialize" />
    </InstallExecuteSequence>

    <Feature Id="DefaultFeature" Title="Main Feature" Level="1">
      <ComponentRef Id="Registration.xml" />
      <ComponentRef Id="ApplicationShortcuts" />
      <ComponentRef Id="DesktopShortcut" />      
    </Feature>


    <Property Id="INSTALLDESKTOPSHORTCUT" Value="1" />
    <!--<Property Id="WIXUI_INSTALLDIR" Value="INSTALLDIR" />-->
    <UIRef Id="WixUI_Minimal"/>
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch DbPass" />
    <Property Id="WixShellExecTarget" Value="dbpassgui.exe" />
    <!-- Step 3: Include the custom action -->
    <CustomAction Id="LaunchApplication" FileKey="dbpassgui.exe" ExeCommand="" Execute="immediate" Impersonate="yes" Return="asyncNoWait" />
  </Product>
</Wix>


